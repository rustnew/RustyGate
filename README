**la liste complÃ¨te, bien structurÃ©e, bien dÃ©finie et prÃªte Ã  Ãªtre suivie** de **toutes les tÃ¢ches du projet RustyGate avec Actix Web**.

Elle est organisÃ©e :

- âœ… **Par phases** (du MVP Ã  la production)
- âœ… **Par composants** (config, proxy, middlewares, observabilitÃ©â€¦)
- âœ… **Avec livrables concrets** Ã  chaque Ã©tape
- âœ… **Avec dÃ©pendances entre tÃ¢ches**
- âœ… **PrÃªte Ã  Ãªtre importÃ©e dans un outil de gestion (GitHub Projects, Notion, Trello, etc.)**

---

# ðŸ§© RustyGate â€” Toutes les TÃ¢ches du Projet (StructurÃ©es & DÃ©finies)

> Reverse Proxy / API Gateway en Rust avec Actix Web â€” Haute performance, observable, extensible.

---

## ðŸ“ Structure de Projet (Rappel)

```
src/
â”œâ”€â”€ main.rs
â”œâ”€â”€ server.rs
â”œâ”€â”€ config.rs
â”œâ”€â”€ proxy_handler.rs
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ auth.rs
â”‚   â”œâ”€â”€ rate_limit.rs
â”‚   â””â”€â”€ cors.rs
â”œâ”€â”€ balancer/
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ round_robin.rs
â”œâ”€â”€ health.rs
â”œâ”€â”€ metrics.rs
â”œâ”€â”€ tracing.rs
â””â”€â”€ plugins/
    â”œâ”€â”€ mod.rs
    â””â”€â”€ manager.rs
```

---

# ðŸš§ PHASE 1 â€” MVP : Serveur + Proxy Basique

> ðŸŽ¯ Livrable : Un proxy qui route `/api/test` â†’ `http://localhost:8001` et renvoie la rÃ©ponse.

---

### âœ… TÃ‚CHE 1.1 â€” Initialiser le projet Rust

- CrÃ©er le projet : `cargo new rustygate --bin`
- Ajouter dÃ©pendances de base dans `Cargo.toml` (sans feature `"test"` pour `actix-web`)
- CrÃ©er la structure de dossiers (`src/middleware`, `src/balancer`, etc.)

---

### âœ… TÃ‚CHE 1.2 â€” Configurer le serveur Actix Web de base

- Dans `src/server.rs` : Ã©crire `start_server()` qui lance un `HttpServer` sur `:8080`
- Dans `main.rs` : appeler `start_server()`
- Tester : `curl http://localhost:8080/` â†’ doit renvoyer â€œRustyGate is runningâ€

---

### âœ… TÃ‚CHE 1.3 â€” DÃ©finir et parser la configuration YAML

- Dans `src/config.rs` :
  - DÃ©finir `struct AppConfig` et `RouteConfig`
  - ImplÃ©menter `load_config(path: &str) -> Result<AppConfig, ConfigError>`
- CrÃ©er `config/default.yaml` avec une route exemple :
  ```yaml
  routes:
    - path: "/api/test"
      backend: "http://localhost:8001"
  ```

---

### âœ… TÃ‚CHE 1.4 â€” ImplÃ©menter le handler de proxying

- Dans `src/proxy_handler.rs` :
  - Ã‰crire `proxy` : handler Actix qui reÃ§oit `HttpRequest` + `web::Data<AppState>`
  - Extraire le path â†’ matcher avec route
  - Forwarder vers backend avec `reqwest`
  - Renvoyer la rÃ©ponse du backend

---

### âœ… TÃ‚CHE 1.5 â€” Forward HTTP complet (headers, body, mÃ©thode)

- Copier :
  - MÃ©thode HTTP
  - Headers (sauf `host`, `content-length`)
  - Body (streamÃ© si possible)
- GÃ©rer les erreurs (backend injoignable â†’ 502)

---

### âœ… TÃ‚CHE 1.6 â€” Ajouter logs structurÃ©s de base

- Configurer `tracing-subscriber` pour logs JSON
- Logger : mÃ©thode, path, status, latency
- Utiliser `tracing-actix-web` pour middleware automatique

---

### âœ… TÃ‚CHE 1.7 â€” Ã‰crire test dâ€™intÃ©gration

- Dans `tests/integration.rs` :
  - Lancer un backend mock (avec `actix-web::test::start`)
  - Lancer RustyGate
  - Appeler `/api/test` â†’ vÃ©rifier rÃ©ponse 200 + body

---

### âœ… TÃ‚CHE 1.8 â€” Valider le MVP

- âœ… `curl` fonctionne
- âœ… Logs JSON visibles
- âœ… Test passe
- âœ… Aucune fuite mÃ©moire (test manuel avec `htop`)

---

# ðŸ§± PHASE 2 â€” Middlewares & ObservabilitÃ© Basique

> ðŸŽ¯ Livrable : Auth JWT, rate limiting, mÃ©triques Prometheus, logs enrichis.

---

### âœ… TÃ‚CHE 2.1 â€” ImplÃ©menter middleware JWT (Auth)

- Dans `src/middleware/auth.rs` :
  - CrÃ©er `JwtAuth` comme `actix_web::middleware::Middleware`
  - VÃ©rifier header `Authorization: Bearer <token>`
  - Config : activer/dÃ©sactiver par route
  - Retourner 401 si invalide

---

### âœ… TÃ‚CHE 2.2 â€” ImplÃ©menter middleware Rate Limiting

- Dans `src/middleware/rate_limit.rs` :
  - Utiliser `HashMap<IpAddr, (Instant, usize)>`
  - Limite : 100 req/min par IP
  - Retourner 429 si dÃ©passÃ©
  - Configurable dans `config.yaml`

---

### âœ… TÃ‚CHE 2.3 â€” ImplÃ©menter middleware CORS

- Dans `src/middleware/cors.rs` :
  - Ajouter headers `Access-Control-Allow-*`
  - Config : `allow_origins`, `allow_methods`

---

### âœ… TÃ‚CHE 2.4 â€” Exposer mÃ©triques Prometheus

- Dans `src/metrics.rs` :
  - Initialiser `metrics_exporter_prometheus`
  - Exposer `/metrics` sur `:8081`
  - DÃ©finir :
    - `requests_total`
    - `request_duration_seconds`
    - `backend_failures_total`

---

### âœ… TÃ‚CHE 2.5 â€” IntÃ©grer mÃ©triques dans le handler

- Dans `proxy_handler.rs` :
  - IncrÃ©menter `requests_total` par status/route
  - Mesurer la latence avec `Histogram::start_timer()`

---

### âœ… TÃ‚CHE 2.6 â€” Tester middlewares

- Test JWT : sans token â†’ 401
- Test rate limit : 101 req en 60s â†’ 429
- Test mÃ©triques : `curl localhost:8081/metrics` â†’ compteurs visibles

---

### âœ… TÃ‚CHE 2.7 â€” Documenter configuration middlewares

- Mettre Ã  jour `README.md` avec exemples de config :
  ```yaml
  middlewares:
    - name: jwt
      enabled: true
    - name: rate_limit
      limit: 100
      window: 60
  ```

---

# âš–ï¸ PHASE 3 â€” Load Balancing & RÃ©silience

> ðŸŽ¯ Livrable : Plusieurs backends, health checks, retry, timeout.

---

### âœ… TÃ‚CHE 3.1 â€” ImplÃ©menter RoundRobin Load Balancer

- Dans `src/balancer/round_robin.rs` :
  - Struct `RoundRobin` avec `Vec<Backend>` + `AtomicUsize`
  - MÃ©thode `select()` â†’ retourne backend suivant

---

### âœ… TÃ‚CHE 3.2 â€” ImplÃ©menter LeastConnections (optionnel)

- MÃªme structure, mais compte connexions actives
- Utile pour backends hÃ©tÃ©rogÃ¨nes

---

### âœ… TÃ‚CHE 3.3 â€” ImplÃ©menter Health Checker

- Dans `src/health.rs` :
  - TÃ¢che pÃ©riodique (`tokio::spawn`) qui ping `/health` sur chaque backend
  - Met Ã  jour `is_healthy: AtomicBool`
  - Ignore les backends unhealthy dans `select()`

---

### âœ… TÃ‚CHE 3.4 â€” Ajouter timeout & retry

- Dans `proxy_handler.rs` :
  - Timeout configurable (ex: 5s) â†’ `reqwest` timeout
  - Si timeout/erreur â†’ retry sur autre backend (max 2 fois)
  - Logger les retries

---

### âœ… TÃ‚CHE 3.5 â€” Tester rÃ©silience

- DÃ©marrer 2 backends â†’ arrÃªter lâ€™un â†’ vÃ©rifier quâ€™il est retirÃ©
- Simuler timeout â†’ vÃ©rifier retry
- VÃ©rifier mÃ©trique `backend_failures_total`

---

### âœ… TÃ‚CHE 3.6 â€” Mettre Ã  jour config pour multi-backends

```yaml
routes:
  - path: "/api/users"
    backends:
      - url: "http://users1:8001"
      - url: "http://users2:8001"
    strategy: "round_robin"
```

---

# ðŸ” PHASE 4 â€” ObservabilitÃ© AvancÃ©e (Tracing)

> ðŸŽ¯ Livrable : Traces distribuÃ©es dans Jaeger, propagation de contexte.

---

### âœ… TÃ‚CHE 4.1 â€” Configurer OpenTelemetry

- Dans `src/tracing.rs` :
  - Initialiser `OtlpTracePipeline`
  - Exporter vers Jaeger (localhost:4317)
  - Installer `tracing_opentelemetry::layer()`

---

### âœ… TÃ‚CHE 4.2 â€” Propager le contexte de tracing

- Extraire `traceparent` des headers entrants
- Injecter dans les requÃªtes sortantes (vers backend)
- Utiliser `opentelemetry::global::get_text_map_propagator().inject()`

---

### âœ… TÃ‚CHE 4.3 â€” CrÃ©er des spans dans le handler

- Span â€œproxy_requestâ€ autour du forward
- Attributs : route, backend, status, duration
- Lier au parent (requÃªte entrante)

---

### âœ… TÃ‚CHE 4.4 â€” Lancer Jaeger localement

```bash
docker run -d -p 16686:16686 -p 6831:6831/udp jaegertracing/all-in-one
```

---

### âœ… TÃ‚CHE 4.5 â€” Tester tracing

- Appeler lâ€™API â†’ vÃ©rifier trace dans Jaeger UI
- VÃ©rifier que `trace_id` dans les logs match la trace

---

### âœ… TÃ‚CHE 4.6 â€” Documenter setup observabilitÃ©

- Fournir `docker-compose.observability.yml`
- Expliquer comment configurer Prometheus + Grafana + Jaeger

---

# ðŸ”„ PHASE 5 â€” Reload Ã  Chaud & Graceful Shutdown

> ðŸŽ¯ Livrable : Reload config sans redÃ©marrer, shutdown propre.

---

### âœ… TÃ‚CHE 5.1 â€” Surveiller les changements de fichier config

- Dans `src/config.rs` :
  - Utiliser `notify::recommended_watcher`
  - Canal `mpsc` pour envoyer Ã©vÃ©nement de reload

---

### âœ… TÃ‚CHE 5.2 â€” Recharger la config dynamiquement

- Stocker `AppConfig` dans `Arc<RwLock<AppState>>`
- Mettre Ã  jour lâ€™Ã©tat sans bloquer les requÃªtes
- Logger â€œConfig reloadedâ€

---

### âœ… TÃ‚CHE 5.3 â€” Ajouter endpoint `/admin/reload`

- Route POST `/admin/reload`
- ProtÃ©gÃ©e par token (configurable)
- Force reload mÃªme sans changement de fichier

---

### âœ… TÃ‚CHE 5.4 â€” ImplÃ©menter graceful shutdown

- Capturer `SIGINT` / `SIGTERM`
- ArrÃªter dâ€™accepter les nouvelles connexions
- Attendre requÃªtes en cours (timeout 30s)
- LibÃ©rer ressources

---

### âœ… TÃ‚CHE 5.5 â€” Tester reload & shutdown

- Modifier `config.yaml` â†’ vÃ©rifier reload â†’ nouvelle route fonctionne
- `Ctrl+C` â†’ vÃ©rifier logs â€œshutting down gracefullyâ€

---

# ðŸ§© PHASE 6 â€” Plugins WASM (ExtensibilitÃ©)

> ðŸŽ¯ Livrable : Plugins en WASM chargÃ©s Ã  chaud, transformant requÃªtes.

---

### âœ… TÃ‚CHE 6.1 â€” Configurer support WASM (feature flag)

- Dans `Cargo.toml` : feature `wasm` avec `wasmer`
- Dans `src/plugins/mod.rs` : trait `Plugin`

---

### âœ… TÃ‚CHE 6.2 â€” DÃ©finir interface plugin standard

```rust
pub trait Plugin {
    fn on_request(&mut self, req: &mut Request) -> Result<(), PluginError>;
    fn on_response(&mut self, res: &mut Response) -> Result<(), PluginError>;
}
```

---

### âœ… TÃ‚CHE 6.3 â€” Charger et exÃ©cuter plugin .wasm

- Dans `src/plugins/manager.rs` :
  - Lire fichier `.wasm`
  - Compiler avec `wasmer`
  - Instancier â†’ appeler `on_request`

---

### âœ… TÃ‚CHE 6.4 â€” Plugin dâ€™exemple : ajouter header

- Ã‰crire plugin en Rust â†’ compiler en WASM
- Ajoute header `X-RustyGate-Plugin: executed`

---

### âœ… TÃ‚CHE 6.5 â€” Hot reload des plugins

- Surveiller dossier `./plugins/`
- Recharger si nouveau fichier dÃ©tectÃ©

---

### âœ… TÃ‚CHE 6.6 â€” Tests plugins

- DÃ©poser plugin â†’ appeler API â†’ vÃ©rifier header ajoutÃ©
- Modifier plugin â†’ reload â†’ vÃ©rifier nouveau comportement

---

# ðŸš€ PHASE 7 â€” Production Ready

> ðŸŽ¯ Livrable : Binaire optimisÃ©, doc complÃ¨te, CI/CD, Helm chart.

---

### âœ… TÃ‚CHE 7.1 â€” Build optimisÃ© (stripping, musl)

```bash
cargo build --release --target x86_64-unknown-linux-musl
strip target/.../rustygate
```

---

### âœ… TÃ‚CHE 7.2 â€” Dockerfile multi-stage

```dockerfile
FROM rust:1.78 AS builder
...
FROM alpine:latest
COPY --from=builder ...
```

---

### âœ… TÃ‚CHE 7.3 â€” CI/CD GitHub Actions

- Workflow : build, test, release binaire Linux/macOS/Windows
- Publier release sur GitHub

---

### âœ… TÃ‚CHE 7.4 â€” Documentation complÃ¨te

- Architecture
- Configuration
- DÃ©ploiement
- Plugins
- ObservabilitÃ©
- FAQ / Troubleshooting

---

### âœ… TÃ‚CHE 7.5 â€” Helm Chart (optionnel)

- Pour dÃ©ployer sur Kubernetes
- Configurable via `values.yaml`

---

### âœ… TÃ‚CHE 7.6 â€” Benchmarking final

- `wrk -t4 -c100 -d30s http://localhost:8080/api/test`
- Objectif : > 10k req/s, latency < 5ms

---

### âœ… TÃ‚CHE 7.7 â€” SÃ©curitÃ© avancÃ©e (optionnel)

- mTLS entre proxy et backends
- WAF basique (regex sur headers/body)
- HTTP/3 (QUIC) avec `quinn` ou `h3`

---

## âœ… CHECKLIST GÃ‰NÃ‰RALE â€” Ã€ COCHER

| Phase | TÃ¢che clÃ© | âœ… |
|-------|-----------|----|
| 1 | Serveur + proxy basique fonctionnel | â˜ |
| 1 | Test dâ€™intÃ©gration passe | â˜ |
| 2 | JWT + Rate Limit + CORS | â˜ |
| 2 | MÃ©triques Prometheus exposÃ©es | â˜ |
| 3 | Load balancing + health checks | â˜ |
| 3 | Timeout + retry fonctionnels | â˜ |
| 4 | Traces visibles dans Jaeger | â˜ |
| 5 | Reload config Ã  chaud | â˜ |
| 5 | Graceful shutdown | â˜ |
| 6 | Plugin WASM exÃ©cutÃ© | â˜ |
| 7 | Binaire statique + Docker | â˜ |
| 7 | CI/CD + doc complÃ¨te | â˜ |

---

## ðŸ—‚ï¸ Fichiers Ã  crÃ©er / modifier â€” Checklist

| Fichier | Statut | âœ… |
|---------|--------|----|
| `Cargo.toml` | DÃ©pendances complÃ¨tes | â˜ |
| `src/main.rs` | Lance serveur | â˜ |
| `src/server.rs` | Setup Actix | â˜ |
| `src/config.rs` | Parsing + reload | â˜ |
| `src/proxy_handler.rs` | Logique de proxy | â˜ |
| `src/middleware/` | Auth, rate limit, CORS | â˜ |
| `src/balancer/` | RoundRobin, LeastConn | â˜ |
| `src/health.rs` | Health checks | â˜ |
| `src/metrics.rs` | Prometheus | â˜ |
| `src/tracing.rs` | OpenTelemetry | â˜ |
| `src/plugins/` | Gestion WASM | â˜ |
| `tests/integration.rs` | Tests bout en bout | â˜ |
| `README.md` | Documentation complÃ¨te | â˜ |
| `Dockerfile` | Build prod | â˜ |
| `.github/workflows/ci.yml` | CI/CD | â˜ |
